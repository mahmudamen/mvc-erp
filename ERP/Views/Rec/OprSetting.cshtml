@{ViewBag.Title = "تصنيف العمليات";}
<nav>
    <ul class="nav nav-justified nav-fixed-top">
        <li class="dropdown">
            <a herf="#" class="dropdown-toggle" role="button" data-toggle="dropdown">الأطباء <span class="caret"></span></a>
            <ul class="dropdown-menu">
                <li><a href='@Url.Action("AddDoctor", "Rec")'>إضافة طبيب</a></li>
                <li class="divider"></li>
                <li><a href='@Url.Action("Doctors", "Rec")'>قائمة الأطباء</a></li>
                <li class="divider"></li>
                <li><a href='@Url.Action("DocDu", "Rec")'>حسابات الأطباء</a></li>
                <li class="divider"></li>
                <li><a href='@Url.Action("GetsDoctor", "Rec")'>أطباء متوقفين</a></li>
            </ul>
        </li>
        <li class="dropdown">
            <a herf="#" class="dropdown-toggle" role="button" data-toggle="dropdown">الخدمات <span class="caret"></span></a>
            <ul class="dropdown-menu">
                <li><a href='@Url.Action("Serv", "Rec")'>قائمة الخدمات</a></li>
                <li class="divider"></li>
                <li><a href='@Url.Action("stopedserv", "Rec")'>خدمات متوقفة</a></li>
                <li class="divider"></li>
                <li><a href='@Url.Action("reportserv", "Rec")'>تقارير</a></li>
                <li class="divider"></li>
            </ul>
        </li>
        <li class="dropdown">
            <a herf="#" class="dropdown-toggle" role="button" data-toggle="dropdown">القسم الداخلي <span class="caret"></span></a>
            <ul class="dropdown-menu">
                <li><a href='@Url.Action("GetRooms", "Rec")'>الغرف</a></li>
                <li><a href='@Url.Action("GstRoom", "Rec")'>غرف متوقفة</a></li>
            </ul>
        </li>
        <li><a href='@Url.Action("OprSetting", "Rec")'>العمليات</a></li>
        <li><a href='@Url.Action("DevSetting", "Rec")'>الأجهزة الطبية</a></li>
    </ul>
</nav>
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">تصنيف العمليات</h3>
    </div>
    <div class="panel-body">
        <div class="form-inline ls_form">
            <label>تصفية</label>
            <div class="form-group">
                @Html.DropDownList("tp", (SelectList)ViewBag.tp, "  -----اختر تصنيف-----  ", htmlAttributes: new { @class = "form-control", @style = "max-width:200px;", id = "tp" })
            </div>
            <div class="form-group">
                @Html.DropDownList("sp", (SelectList)ViewBag.sp, "  -----اختر تخصص-----  ", htmlAttributes: new { @class = "form-control", @style = "max-width:200px;", id = "sp" })
            </div>
        </div>
        <br />
        <div class="col-md-2 pull-left" id="bcon">
            <div class="row">
                <span class="pull-left">|</span>
                <button class="small btn-primary pull-left" id="ad" title="Add"><i class="glyphicon glyphicon-plus"></i></button><span class="pull-left">|</span>
                <button class="small btn-info pull-left" id="ed" title="Edit"><i class="glyphicon glyphicon-edit"></i></button><span class="pull-left">|</span>
                <button class="small btn-warning pull-left" id="rf" title="Refresh"><i class="glyphicon glyphicon-refresh"></i></button>
            </div>
        </div>
        <table id="example" class="table table-striped table-bordered dt-responsive" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th></th>
                    <th class="text-center">اسم</th>
                    <th></th>
                    <th class="text-center">تصنيف</th>
                    <th class="text-center">تخصص</th>
                    <th></th>
                    <th></th>
                    <th class="text-center">الخدمة</th>
                    <th class="text-center">القيمة</th>
                    <th class="text-center">م.ادارية</th>
                    <th class="text-center">شاملة</th>
                    <th class="text-center">ترتيب</th>
                    <th class="text-center">الحالة</th>
                    <th class="text-center">مستخدم</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="adopr">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <label class="modal-title">بيانات العملية</label>
            </div>
            <div class="modal-body">
                <input type="hidden" id="oprid" />
                    <div class="form-inline ls_form">
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label>اســــم</label>
                            <input type="text" id="oprn" class="form-control" style="max-width:500px;min-width:450px" maxlength="150" />
                        </div>
                    </div>
                <br />
                    <div class="form-inline ls_form">
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label style="margin:0px 0px 0px 5px">تصنيف</label>
                            @Html.DropDownList("oprtyp", (SelectList)ViewBag.tp, "  -----اختر تصنيف-----  ", htmlAttributes: new { @class = "form-control", @style = "min-width:200px;", id = "oprtyp" })
                        </div>
                    </div>
                <br />
                    <div class="form-inline ls_form">
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label style="margin:0px 0px 0px 5px">تخصص</label>
                            @Html.DropDownList("oprspc", (SelectList)ViewBag.sp, "  -----اختر تخصص-----  ", htmlAttributes: new { @class = "form-control", @style = "min-width:200px;", id = "oprspc" })
                        </div>
                    </div>
                <br />
                    <div class="form-inline ls_form">
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label style="margin:0px 0px 0px 5px">خدمة العمليات</label>
                            @Html.DropDownList("srop", (SelectList)ViewBag.srop, "  -----اختر الخدمة-----  ", htmlAttributes: new { @class = "form-control", @style = "max-width:200px;", id = "srop" })
                        </div>
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label style="margin:0px 30px 0px 20px">القيمة</label>
                            <input type="number" id="sval" class="form-control text-center" style="max-width:90px" min="0" value="0" />
                        </div>
                    </div>
                <br />
                    <div class="form-inline ls_form">
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label>شاملة</label>
                            <input type="checkbox" id="aval" class="checkbox" />
                        </div>
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label>م.ادارية</label>
                            <input type="checkbox" id="mexp" class="checkbox" checked="checked" />
                        </div>
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label style="margin:0px 0px 0px 5px">ترتيب</label>
                            <input type="number" id="ord" class="form-control text-center" style="max-width:50px" min="0" value="0" />
                        </div>
                        <div class="form-group" style="margin:0px 5px 0px 5px">
                            <label style="margin:0px 0px 0px 5px">الحالة</label>
                            <input type="checkbox" id="iac" class="checkbox" checked="checked" />
                        </div>
                    </div>
                <div class="form-inline ls_form">
                    <div class="form-group" style="margin:0px 5px 0px 5px">
                        <label>المستخدم</label>
                        <input type="password" id="cby" class="form-control text-center" style="max-width:80px" maxlength="4" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="javascript:;" id="rsve" type="button" class="btn btn-sm btn-success">حفظ</a>
                <a href="javascript:;" id="esve" type="button" class="btn btn-sm btn-info">تعديل</a>
                <a type="button" href="javascript:;" class="btn btn-sm btn-danger" data-dismiss="modal">إغلاق</a>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script src="~/Scripts/dts.js"></script>
    <script>
        $(document).ready(function () {
            $("#adopr").on('hidden.bs.modal', function () {
                var table = $("#example").DataTable();
                table.ajax.reload(null, false);
                $("#cby,#oprn,#oprid,#ord").val('');
                $("#oprtyp,#oprspc,#ord,#srop,#sval").val(0);
                $("#iac").prop('checked', true); $("#mexp").prop('checked', true);
                $('#rsve').prop('disabled', false);
            });
            $('#rsve').click(function () {
                $('#rsve').prop('disabled', true);
                if ($('#oprn').val() == '') {
                    alert('يجب تحديد اسم العملية')
                    $('#oprn').focus();
                    $('#rsve').prop('disabled', false);
                }
                else if ($('#srop').val() == 0) {
                    alert('يجب تحديد خدمة فتح غرفة العمليات')
                    $('#srop').focus();
                    $('#rsve').prop('disabled', false);
                }
                else if ($('#cby').val() == '') {
                    alert('يجب تحديد مستخدم')
                    $('#cby').focus();
                    $('#rsve').prop('disabled', false);
                }
                else {
                    $.ajax({
                        url: "@(Url.Action("adopr", "Rec"))",
                        type: "GET",
                        contentType: "application/json; charset=utf-8",
                        data: {
                            cby: $('#cby').val(), oprnam: $('#oprn').val(), oprtyp: $("#oprtyp").val(), servn: $('#srop option:selected').text(),
                            oprtn: $('#oprtyp option:selected').text(), oprspc: $("#oprspc").val(), serv: $('#srop').val(), 
                            mexp: $('#mexp').is(':checked'), ord: $('#ord').val(), servv: $('#sval').val(), aval: $('#aval').is(':checked'), iac: $('#iac').is(':checked')
                        },
                    dataType: "json",
                    success: function (data) {
                        if (data) {
                            alert('تم اضافة العملية بنجاح')
                            $("#adopr").modal("hide");
                            $('#rsve').prop('disabled', false);
                            var table = $("#example").DataTable();
                            table.ajax.reload(null, false);
                        }
                        else {
                            alert('يوجد عملية بنفس الاسم')
                            $('#rsve').prop('disabled', false);
                        }
                    }
                });
            }
            });
            $('#esve').click(function () {
                if ($('#oprn').val() == '') {
                    alert('يجب تحديد اسم العملية')
                    $('#oprn').focus();
                }
                else if ($('#srop').val() == 0) {
                    alert('يجب تحديد خدمة فتح غرفة العمليات')
                    $('#srop').focus();
                    $('#rsve').prop('disabled', false);
                }
                else if ($('#cby').val() == '') {
                    alert('يجب تحديد مستخدم')
                    $('#cby').focus();
                    $('#rsve').prop('disabled', false);
                }
                else {
                    $.ajax({
                        url: "@(Url.Action("edopr", "Rec"))",
                        type: "GET",
                    contentType: "application/json; charset=utf-8",
                    data: {
                        cby: $('#cby').val(), id: $('#oprid').val(), oprnam: $('#oprn').val(), oprtyp: $("#oprtyp").val(),
                        oprtn: $('#oprtyp option:selected').text(), oprspc: $("#oprspc").val(), serv: $('#srop').val(), servn: $('#srop option:selected').text(),
                        mexp: $('#mexp').is(':checked'), ord: $('#ord').val(), servv: $('#sval').val(), aval: $('#aval').is(':checked'), iac: $('#iac').is(':checked')
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data) {
                            alert('تم تعديل العملية بنجاح')
                            $("#adopr").modal("hide");
                            $('#rsve').prop('disabled', false);
                        }
                        else {
                            alert('يوجد عملية بنفس الاسم')
                            $('#rsve').prop('disabled', false);
                        }
                    }
                });
            }
            });
            $(window).keydown(function (e) {
                if (event.which === 119) {
                    $('#ad').click();
                }
                else if (event.which === 120) {
                    $('#ed').click();
                }
            });
            $('#tp,#sp').change(function () {
                var table = $("#example").DataTable();
                table.$('tr.selected').removeClass('selected');
                table.clear();
                table.draw();
                table.ajax.url('/Haf/Rec/fopr?tp=' + $('#tp').val() + '&sp=' + $('#sp').val()).load();
            })
            var table = $('#example').DataTable({
                fixedHeader: true, "order": [[11, "desc"]], "pageLength": 15, sAjaxSource: '/Haf/Rec/fopr?tp=' + $('#tp').val() + '&sp=' + $('#sp').val(),
                lengthChange: false, dom: 'Bfrtip',
                buttons: [{
                    extend: 'print', title: function () { return 'مستشفي حفصة العوضي التخصصي' }, text: '<i class="glyphicon glyphicon-print"></i>',
                    exportOptions: { modifier: { page: 'current' }, columns: [ 1, 3, 4, 7, 8, 9, 10, 11, 12 ] },
                    customize: function (win) {
                        $(win.document.body).find('table').addClass('display').css('font-size', '12px');
                        $(win.document.body).find('h4').css('text-align', 'center');
                        $(win.document.body).find('h4').text('تصنيف العمليات الجراحية');
                    }
                },
                ],
                columns: [
            { "data": "ID", "visible": false },
            { "data": "Operation", "width": "35%" },
            { "data": "OperType", "visible": false },
            { "data": "OperTn", "width": "10%", "sClass": "dt-center" },
            { "data": "Name", "width": "10%", "sClass": "dt-center" },
            { "data": "Spec", "visible": false },
            { "data": "Serv", "visible": false },
            { "data": "Servn", "width": "15%", "sClass": "dt-center" },
            { "data": "ServVal", "width": "5%", "sClass": "dt-center" },
            {
                "data": "Mexp", "width": "5%", "sClass": "dt-center", "render": function (data, type, full, meta) {
                    var is_checked = data == true ? "checked" : "";
                    return '<input type="checkbox" id=mxp class="checkbox" ' +
                        is_checked + ' />'
                }
            },
            {
                "data": "aval", "width": "5%", "sClass": "dt-center", "render": function (data, type, full, meta) {
                    var is_checked = data == true ? "checked" : "";
                    return '<input type="checkbox" id=avl class="checkbox" ' +
                        is_checked + ' />'
                }
            },
            { "data": "Ord", "width": "5%", "sClass": "dt-center" },
            {
                "data": "IsActive", "width": "5%", "sClass": "dt-center", "render": function (data, type, full, meta) {
                    var is_checked = data == true ? "checked" : "";
                    return '<input type="checkbox" id=isa class="checkbox" ' +
                        is_checked + ' />'
                }
            },
            { "data": "Cbyn", "width": "5%", "sClass": "dt-center" },
                ]
            });
            $('#bcon').appendTo('#example_filter')
            $('#ad').click(function () {
                var table = $("#example").DataTable();
                table.$('tr.selected').removeClass('selected');
                $('#adopr').modal({ backdrop: false });
                document.getElementById("rsve").style.display = "inline-block";
                document.getElementById("esve").style.display = "none";
                $('#oprn').focus();
            });
            $('#rf').click(function () {
                var table = $("#example").DataTable();
                table.ajax.reload(null, false);
            });
            $('#ed').click(function () {
                var table = $("#example").DataTable();
                if (table.cell('.selected', 0).data()) {
                    document.getElementById("esve").style.display = "inline-block";
                    document.getElementById("rsve").style.display = "none";
                    $("#oprid").val(table.cell('.selected', 0).data());
                    $("#oprn").val(table.cell('.selected', 1).data());
                    $("#oprtyp").val(table.cell('.selected', 2).data());
                    $("#oprspc").val(table.cell('.selected', 5).data());
                    $("#srop").val(table.cell('.selected', 6).data());
                    $("#sval").val(table.cell('.selected', 8).data());
                    if (table.cell('.selected', 9).data())
                    { $("#mexp").prop('checked', true); }
                    else { $("#mexp").prop('checked', false); }
                    if (table.cell('.selected', 10).data())
                    { $("#aval").prop('checked', true); }
                    else { $("#aval").prop('checked', false); }
                    $("#ord").val(table.cell('.selected', 11).data());
                    if (table.cell('.selected', 12).data())
                    { $("#iac").prop('checked', true); }
                    else { $("#iac").prop('checked', false); }
                    $('#adopr').modal({ backdrop: false });
                    $('#oprn').focus();
                }
                else { alert("قم بتحديد بند أولا") }
            });
            $('#example tbody').on('click', 'tr', function () {
                var table = $("#example").DataTable();
                table.$('tr.selected').removeClass('selected');
                $(this).closest('tr').addClass('selected')
            });
            $('#example tbody').on('change', '#mxp', function () {
                var table = $("#example").DataTable();
                table.$('tr.selected').removeClass('selected');
                $(this).closest('tr').addClass('selected')
                //$('#isa').removeAttr('checked');
                $.ajax({
                    url: "@(Url.Action("edopr", "Rec"))",
                        type: "GET",
                    contentType: "application/json; charset=utf-8",
                    data: {
                        cby: 1234, id: table.cell('.selected', 0).data(), oprnam: table.cell('.selected', 1).data(), oprtyp: table.cell('.selected', 2).data(),
                        oprtn: table.cell('.selected', 3).data(), oprspc: table.cell('.selected', 5).data(), serv: table.cell('.selected', 6).data(),
                        servn: table.cell('.selected', 7).data(),
                        mexp: $(this).is(':checked'), ord: table.cell('.selected', 11).data(), servv: table.cell('.selected', 8).data(),
                        aval: $('#avl').is(':checked'), iac: $('#isa').is(':checked')
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data) {
                            var table = $("#example").DataTable();
                            table.ajax.reload(null, false);
                        }
                    }
                });
            });
            $('#example tbody').on('change', '#avl', function () {
                var table = $("#example").DataTable();
                table.$('tr.selected').removeClass('selected');
                $(this).closest('tr').addClass('selected')
                //$('#isa').removeAttr('checked');
                $.ajax({
                    url: "@(Url.Action("edopr", "Rec"))",
                    type: "GET",
                contentType: "application/json; charset=utf-8",
                data: {
                    cby: 1234, id: table.cell('.selected', 0).data(), oprnam: table.cell('.selected', 1).data(), oprtyp: table.cell('.selected', 2).data(),
                    oprtn: table.cell('.selected', 3).data(), oprspc: table.cell('.selected', 5).data(), serv: table.cell('.selected', 6).data(),
                    servn: table.cell('.selected', 7).data(),
                    mexp: $('#mxp').is(':checked'), ord: table.cell('.selected', 11).data(), servv: table.cell('.selected', 8).data(),
                    aval: $(this).is(':checked'), iac: $('#isa').is(':checked')
                },
                dataType: "json",
                success: function (data) {
                    if (data) {
                        var table = $("#example").DataTable();
                        table.ajax.reload(null, false);
                    }
                }
            });
            });
            $('#example tbody').on('change', '#isa', function () {
                var table = $("#example").DataTable();
                table.$('tr.selected').removeClass('selected');
                $(this).closest('tr').addClass('selected')
                //$('#isa').removeAttr('checked');
                $.ajax({
                    url: "@(Url.Action("edopr", "Rec"))",
                    type: "GET",
                contentType: "application/json; charset=utf-8",
                data: {
                    cby: 1234, id: table.cell('.selected', 0).data(), oprnam: table.cell('.selected', 1).data(), oprtyp: table.cell('.selected', 2).data(),
                    oprtn: table.cell('.selected', 3).data(), oprspc: table.cell('.selected', 5).data(), serv: table.cell('.selected', 6).data(),
                    servn: table.cell('.selected', 7).data(),
                    mexp: $('#mxp').is(':checked'), ord: table.cell('.selected', 11).data(), servv: table.cell('.selected', 8).data(),
                    aval: $('#avl').is(':checked'), iac: $(this).is(':checked')
                },
                dataType: "json",
                success: function (data) {
                    if (data) {
                        var table = $("#example").DataTable();
                        table.ajax.reload(null, false);
                    }
                }
            });
        });
        });
    </script>
}